<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ’¬ Chat with Singaseong</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    #chat-box {
      width: 90%;
      max-width: 600px;
      height: 70vh;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-top: 1em;
      overflow-y: auto;
      padding: 1em;
    }
    .msg {
      margin: 0.4em 0;
      line-height: 1.4;
    }
    .user {
      color: #0074D9;
    }
    .bot {
      color: #222;
      background: #eee;
      border-radius: 6px;
      padding: 0.3em 0.6em;
      display: inline-block;
    }
    .system {
      color: #555;
      font-style: italic;
    }
    #input-box {
      display: flex;
      width: 90%;
      max-width: 600px;
      margin-top: 1em;
    }
    #prompt {
      flex: 1;
      padding: 0.6em;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }
    #send {
      margin-left: 0.5em;
      padding: 0.6em 1.2em;
      background: #0074D9;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #send:disabled {
      opacity: 0.6;
      cursor: wait;
    }
  </style>
</head>
<body>
  <h2>ðŸ’¬ Chat with Singaseong</h2>
  <div id="chat-box"></div>

  <div id="input-box">
    <input id="prompt" type="text" placeholder="Type your message..." autocomplete="off" />
    <button id="send">Send</button>
  </div>

  <script type="module">
    import { createSingaseongClient } from './chat.js';

    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('prompt');
    const sendBtn = document.getElementById('send');

    const client = createSingaseongClient();
    const conversation = [];

    function appendMessage(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    function recordMessage(role, content) {
      conversation.push({ role, content });
    }

    function extractAssistantReply(result) {
      if (!result && result !== 0) {
        return 'No response received from the API.';
      }

      if (typeof result === 'string') {
        return result;
      }

      if (typeof result === 'object') {
        if (result.reply) {
          return result.reply;
        }
        if (result.response) {
          return result.response;
        }
        if (result.message) {
          return result.message;
        }
        if (Array.isArray(result.choices) && result.choices[0]?.message?.content) {
          return result.choices[0].message.content;
        }
      }

      try {
        return JSON.stringify(result, null, 2);
      } catch (error) {
        return String(result);
      }
    }

    async function sendMessage() {
      const prompt = input.value.trim();
      if (!prompt) return;

      appendMessage('user', `You: ${prompt}`);
      recordMessage('user', prompt);
      input.value = '';

      const thinkingMessage = appendMessage('bot', 'Assistant: Thinking...');
      sendBtn.disabled = true;
      input.disabled = true;

      try {
        const result = await client.sendChatMessage({
          prompt,
        });
        const reply = extractAssistantReply(result);
        thinkingMessage.textContent = `Assistant: ${reply}`;
        recordMessage('assistant', reply);
      } catch (error) {
        thinkingMessage.textContent = `Assistant: ${error.message}`;
      } finally {
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
      }
    });

    window.addEventListener('load', async () => {
      try {
        if (!client.hasCredentials) {
          appendMessage('system', 'Missing CF Access credentials. Please configure CF_ACCESS_CLIENT_ID and CF_ACCESS_CLIENT_SECRET.');
          return;
        }

        const status = await client.ping();
        if (typeof status === 'string') {
          appendMessage('system', `Connected to Singaseong API: ${status}`);
        } else {
          appendMessage('system', 'Connected to Singaseong API.');
        }
      } catch (error) {
        appendMessage('system', `Unable to reach Singaseong API: ${error.message}`);
      }
    });
  </script>
</body>
</html>
